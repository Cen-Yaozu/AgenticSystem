
# Agentic 多角色架构设计

> **版本**: 2.0.0
> **状态**: Draft
> **最后更新**: 2024-12-17

---

## 1. 概述

本文档定义 AgentX Agentic RAG 系统的核心架构模式：**助手-子代理协作系统**。

### 1.1 什么是 Agentic 架构

传统 RAG 系统采用固定的流水线模式：
```
用户输入 → 向量检索 → 上下文拼接 → LLM 生成 → 输出
```

Agentic RAG 系统采用**智能代理协作**模式：
```
用户输入 → 助手分析 → 委派子代理 → 智能处理 → 协调整合 → 输出
```

### 1.2 核心理念

| 理念 | 描述 |
|------|------|
| **角色即专家** | 每个角色是特定领域的专家，拥有专业知识和记忆 |
| **助手-子代理协作** | 助手（主角色）负责协调，子代理负责执行具体任务 |
| **智能委派** | 助手根据任务类型智能选择合适的子代理 |
| **记忆驱动** | 角色通过 PromptX 记忆系统积累经验，越用越智能 |

### 1.3 技术栈分工

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           技术栈分工                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    业务层 (Agentic RAG 应用)                         │   │
│  │                                                                       │   │
│  │  • 助手管理 (Assistant CRUD)                                         │   │
│  │  • 文档管理 (Document CRUD)                                          │   │
│  │  • 业务逻辑                                                           │   │
│  │                                                                       │   │
│  │  存储：SQLite (better-sqlite3)                                       │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Agent 框架 (执行层)                                │   │
│  │                                                                       │   │
│  │  • Claude Code 能力                                                   │   │
│  │  • LLM 接入                                                           │   │
│  │  • Session/Message 管理                                               │   │
│  │  • 对话过程中调用 PromptX 激活角色（助手/子代理）                     │   │
│  │                                                                       │   │
│  │  存储：unstorage (支持多后端)                                         │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    │ MCP 调用（对话过程中）                 │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    PromptX (资源层)                                   │   │
│  │                                                                       │   │
│  │  • 角色资源 (助手 + 子代理都是 PromptX 角色)                          │   │
│  │  • 工具资源 (Tool Definitions)                                        │   │
│  │  • 记忆系统 (Engrams)                                                 │   │
│  │                                                                       │   │
│  │  对话过程中：                                                         │   │
│  │  • promptx_action(role) - 激活助手或子代理角色                        │   │
│  │  • promptx_recall(role, query) - 检索角色记忆                         │   │
│  │  • promptx_remember(role, engrams) - 保存角色记忆                     │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    向量数据库 (Qdrant)                                │   │
│  │                                                                       │   │
│  │  • 文档向量                                                           │   │
│  │  • 摘要向量                                                           │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.4 助手与子代理的运行机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        对话过程中的角色切换                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户消息                                                                   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Agent 框架接收消息                                                   │   │
│  │      │                                                               │   │
│  │      │ MCP: promptx_action({ role: 'legal-advisor' })               │   │
│  │      ▼                                                               │   │
│  │  PromptX 激活助手角色（主角色）                                       │   │
│  │      │                                                               │   │
│  │      │ 助手分析意图，决定需要检索文档                                │   │
│  │      │                                                               │   │
│  │      │ MCP: promptx_action({ role: 'retriever' })                   │   │
│  │      ▼                                                               │   │
│  │  PromptX 激活检索子代理                                               │   │
│  │      │                                                               │   │
│  │      │ 子代理执行检索任务，返回结果                                  │   │
│  │      │                                                               │   │
│  │      │ MCP: promptx_action({ role: 'legal-advisor' })               │   │
│  │      ▼                                                               │   │
│  │  PromptX 切回助手角色                                                 │   │
│  │      │                                                               │   │
│  │      │ 助手整合结果，生成回复                                        │   │
│  │      │                                                               │   │
│  │      │ MCP: promptx_remember({ role: 'legal-advisor', ... })        │   │
│  │      ▼                                                               │   │
│  │  PromptX 保存对话记忆                                                 │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  流式响应给用户                                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**关键点**：
- 助手和子代理在 PromptX 中都是"角色"（Role）
- Agent 框架在对话过程中通过 MCP 调用 PromptX 来激活不同角色
- 角色切换发生在对话过程中，由 Agent 框架协调
- 每个角色都有自己的记忆，通过 PromptX 的 remember/recall 管理

### 1.4 与传统 RAG 的区别

| 特性 | 传统 RAG | Agentic RAG |
|------|----------|-------------|
| 检索方式 | 向量相似度匹配 | 角色智能理解 + 向量检索 |
| 分块策略 | 固定规则分块 | AI 角色语义分块 |
| 上下文理解 | 关键词匹配 | 业务语义理解 |
| 响应生成 | 单一 LLM 调用 | 助手-子代理协作生成 |
| 学习能力 | 无 | 通过 PromptX 记忆系统持续学习 |

---

## 2. 角色体系

### 2.1 角色层次结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              角色层次结构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         助手 (Assistant)                             │   │
│  │                         = 主角色 (Main Role)                         │   │
│  │                                                                       │   │
│  │  职责：                                                               │   │
│  │  • 接收用户输入，理解意图                                             │   │
│  │  • 分析任务类型，决定处理策略                                         │   │
│  │  • 委派任务给合适的子代理                                             │   │
│  │  • 整合子代理返回的结果                                               │   │
│  │  • 与用户进行自然对话                                                 │   │
│  │                                                                       │   │
│  │  实现：通过 Agent 框架 + PromptX 角色资源                             │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                    ┌───────────────┼───────────────┐                        │
│                    ▼               ▼               ▼                        │
│  ┌─────────────────────┐ ┌─────────────────┐ ┌─────────────────────┐       │
│  │   文档处理子代理     │ │   检索子代理     │ │   领域专家子代理     │       │
│  │   (Doc Processor)   │ │   (Retriever)   │ │   (Domain Expert)   │       │
│  │                     │ │                 │ │                     │       │
│  │  职责：             │ │  职责：         │ │  职责：             │       │
│  │  • 理解文档结构     │ │  • 语义检索     │ │  • 领域知识问答     │       │
│  │  • 智能分块         │ │  • 相关性排序   │ │  • 专业术语解释     │       │
│  │  • 提取关键信息     │ │  • 上下文组装   │ │  • 业务逻辑分析     │       │
│  │  • 生成摘要         │ │  • 来源标注     │ │  • 建议生成         │       │
│  │                     │ │                 │ │                     │       │
│  │  实现：Claude Code  │ │  实现：Claude   │ │  实现：PromptX      │       │
│  │  SubAgent 机制      │ │  Code SubAgent  │ │  角色资源           │       │
│  └─────────────────────┘ └─────────────────┘ └─────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 术语说明

| 术语 | 英文 | 说明 |
|------|------|------|
| 助手 | Assistant | 用户创建的专业领域 AI 助手，是主角色的业务层表现 |
| 主角色 | Main Role | 面向用户的角色，负责协调和整合 |
| 子代理 | SubAgent | 执行具体任务的专业代理，利用 Claude Code 的 subagent 机制 |
| 角色 | Role | PromptX 中的角色资源，主角色和子代理在 PromptX 中都是角色 |

### 2.3 角色定义

#### 2.3.1 助手 (Assistant) = 主角色

助手是用户的直接对话对象，负责整体协调。

```typescript
interface Assistant {
  id: string;                      // 格式: asst_xxxxxxxx
  userId: string;
  name: string;                    // 如 "法律顾问"、"技术专家"
  description: string;
  domain: string;                  // 专业领域

  // 核心能力
  capabilities: {
    intentAnalysis: boolean;       // 意图分析
    taskDelegation: boolean;       // 任务委派
    resultIntegration: boolean;    // 结果整合
    conversationManagement: boolean; // 对话管理
  };

  // 人格设置
  personality: {
    tone: 'formal' | 'friendly' | 'professional';
    verbosity: 'concise' | 'detailed' | 'balanced';
    expertise: string[];           // 专业领域
  };

  // 关联的子代理
  subAgents: SubAgent[];

  // PromptX 角色 ID（用于 MCP 调用）
  promptxRoleId: string;
}
```

#### 2.3.2 子代理 (SubAgent)

子代理是执行具体任务的专家，利用 Claude Code 的 subagent 机制实现。

```typescript
interface SubAgent {
  id: string;
  type: 'document_processor' | 'retriever' | 'domain_expert';
  name: string;
  description: string;

  // 触发条件
  triggers: {
    keywords: string[];            // 触发关键词
    intentTypes: string[];         // 触发意图类型
    documentTypes?: string[];      // 适用文档类型
  };

  // 能力配置
  capabilities: Record<string, any>;

  // PromptX 角色 ID（用于 MCP 调用）
  promptxRoleId: string;
}
```

### 2.4 助手与子代理的关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              助手 (Assistant)                                │
│                              "法律顾问"                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         主角色 (PromptX Role)                        │   │
│  │                         promptxRoleId: "legal-advisor"               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                    ┌───────────────┼───────────────┐                        │
│                    ▼               ▼               ▼                        │
│  ┌─────────────────────┐ ┌─────────────────┐ ┌─────────────────────┐       │
│  │   文档处理子代理     │ │   检索子代理     │ │   合同专家子代理     │       │
│  │   (Claude SubAgent) │ │   (Claude Sub.) │ │   (PromptX Role)    │       │
│  │   doc-processor     │ │   retriever     │ │   contract-expert   │       │
│  └─────────────────────┘ └─────────────────┘ └─────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           文档知识库                                  │   │
│  │  • 合同模板.pdf                                                       │   │
│  │  • 法律条款.docx                                                      │   │
│  │  • 案例分析.md                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           角色记忆 (PromptX Engrams)                  │   │
│  │  • 用户偏好                                                           │   │
│  │  • 历史问答                                                           │   │
│  │  • 学习到的知识                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据流设计

### 3.1 文档处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           文档处理流程 (Agentic)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐    ┌─────────────────────────────────────────────────────┐    │
│  │ 用户上传 │───▶│                  文档处理角色                        │    │
│  │  文档    │    │                                                     │    │
│  └─────────┘    │  1. 文档类型识别                                     │    │
│                 │     • 识别文档格式（PDF/Word/Excel）                 │    │
│                 │     • 判断文档类型（合同/报告/手册）                 │    │
│                 │                                                     │    │
│                 │  2. 智能文本提取                                     │    │
│                 │     • 提取正文内容                                   │    │
│                 │     • 识别标题层级                                   │    │
│                 │     • 提取表格数据                                   │    │
│                 │                                                     │    │
│                 │  3. 语义分块                                         │    │
│                 │     • 理解文档结构                                   │    │
│                 │     • 按语义边界分块（非固定字符数）                 │    │
│                 │     • 保持上下文完整性                               │    │
│                 │                                                     │    │
│                 │  4. 信息增强                                         │    │
│                 │     • 为每个块生成摘要                               │    │
│                 │     • 提取关键词和实体                               │    │
│                 │     • 标注块的类型（定义/条款/示例）                 │    │
│                 │                                                     │    │
│                 └─────────────────────────────────────────────────────┘    │
│                                         │                                   │
│                                         ▼                                   │
│                 ┌─────────────────────────────────────────────────────┐    │
│                 │                    向量化存储                        │    │
│                 │                                                     │    │
│                 │  • 原始内容 → Embedding → Qdrant                    │    │
│                 │  • AI 摘要 → Embedding → Qdrant                     │    │
│                 │  • 元数据 → SQLite                                  │    │
│                 │                                                     │    │
│                 └─────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 对话处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           对话处理流程 (Agentic)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐                                                                │
│  │ 用户消息 │                                                                │
│  └────┬────┘                                                                │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         主角色 (Coordinator)                         │   │
│  │                                                                       │   │
│  │  1. 意图分析                                                          │   │
│  │     • 理解用户问题                                                    │   │
│  │     • 识别问题类型（查询/分析/建议/闲聊）                            │   │
│  │     • 提取关键实体                                                    │   │
│  │                                                                       │   │
│  │  2. 记忆回忆 (recall)                                                 │   │
│  │     • 检索相关历史记忆                                                │   │
│  │     • 获取用户偏好                                                    │   │
│  │     • 加载领域知识                                                    │   │
│  │                                                                       │   │
│  │  3. 任务委派决策                                                      │   │
│  │     • 判断是否需要检索文档                                            │   │
│  │     • 判断是否需要领域专家                                            │   │
│  │     • 决定委派策略                                                    │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│              ┌─────────────────────┼─────────────────────┐                  │
│              ▼                     ▼                     ▼                  │
│  ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐         │
│  │    检索角色        │ │   领域专家角色     │ │   直接回答         │         │
│  │                   │ │                   │ │   (无需委派)       │         │
│  │  • 语义检索       │ │  • 专业分析       │ │                   │         │
│  │  • 相关性排序     │ │  • 术语解释       │ │                   │         │
│  │  • 上下文组装     │ │  • 建议生成       │ │                   │         │
│  │                   │ │                   │ │                   │         │
│  └─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘         │
│            │                     │                     │                    │
│            └─────────────────────┼─────────────────────┘                    │
│                                  ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         主角色整合结果                                │   │
│  │                                                                       │   │
│  │  • 整合子角色返回的信息                                               │   │
│  │  • 组织回答结构                                                       │   │
│  │  • 添加来源引用                                                       │   │
│  │  • 生成自然语言回复                                                   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         记忆保存 (remember)                           │   │
│  │                                                                       │   │
│  │  • 保存本次对话的关键信息                                             │   │
│  │  • 更新用户偏好                                                       │   │
│  │  • 积累领域知识                                                       │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────┐                                                                │
│  │ 流式输出 │                                                                │
│  └─────────┘                                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. PromptX MCP 集成

### 4.1 集成架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PromptX MCP 集成架构                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         AgentX 应用层                                 │   │
│  │                                                                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │   │
│  │  │ Assistant   │  │ Document    │  │Conversation │                   │   │
│  │  │ Service     │  │ Service     │  │ Service     │                   │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                   │   │
│  │         │                │                │                           │   │
│  └─────────┼────────────────┼────────────────┼───────────────────────────┘   │
│            │                │                │                               │
│            └────────────────┼────────────────┘                               │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         MCP Client                                    │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐     │   │
│  │  │                    PromptX MCP Protocol                      │     │   │
│  │  │                                                               │     │   │
│  │  │  • promptx_action(role)     - 激活角色                       │     │   │
│  │  │  • promptx_recall(role, query) - 检索记忆                    │     │   │
│  │  │  • promptx_remember(role, engrams) - 保存记忆                │     │   │
│  │  │  • promptx_discover()       - 发现可用角色                   │     │   │
│  │  │                                                               │     │   │
│  │  └─────────────────────────────────────────────────────────────┘     │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         PromptX Server                                │   │
│  │                                                                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │   │
│  │  │ Role        │  │ Memory      │  │ Tool        │                   │   │
│  │  │ Manager     │  │ System      │  │ Runtime     │                   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 MCP 调用示例

#### 激活角色
```typescript
// 激活文档处理角色
const result = await mcpClient.call('promptx_action', {
  role: 'document-processor'
});

// 返回角色配置和记忆网络
// {
//   role: { name, description, capabilities },
//   memoryNetwork: { nodes, edges }
// }
```

#### 检索记忆
```typescript
// DMN 模式 - 查看记忆全景
const memories = await mcpClient.call('promptx_recall', {
  role: 'legal-advisor',
  query: null  // null 表示 DMN 模式
});

// 关键词检索
const memories = await mcpClient.call('promptx_recall', {
  role: 'legal-advisor',
  query: '合同 违约 赔偿',
  mode: 'balanced'
});
```

#### 保存记忆
```typescript
await mcpClient.call('promptx_remember', {
  role: 'legal-advisor',
  engrams: [{
    content: '用户偏好简洁的回答风格',
    schema: '用户 偏好 简洁 回答',
    strength: 0.8,
    type: 'ATOMIC'
  }]
});
```

---

## 5. 存储策略

### 5.1 数据分层存储

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              存储策略                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         SQLite (关系数据)                             │   │
│  │                                                                       │   │
│  │  存储内容：                                                           │   │
│  │  • 用户信息 (users)                                                   │   │
│  │  • 助手配置 (assistants)                                              │   │
│  │  • 文档元数据 (documents)                                             │   │
│  │  • 对话记录 (conversations, messages)                                 │   │
│  │  • 角色配置 (roles)                                                   │   │
│  │  • 记忆数据 (memories)                                                │   │
│  │                                                                       │   │
│  │  特点：                                                               │   │
│  │  • 事务支持                                                           │   │
│  │  • 关系查询                                                           │   │
│  │  • 数据一致性                                                         │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Qdrant (向量数据)                             │   │
│  │                                                                       │   │
│  │  存储内容：                                                           │   │
│  │  • 文档块向量 (document_vectors)                                      │   │
│  │    - 原始内容向量                                                     │   │
│  │    - AI 摘要向量                                                      │   │
│  │    - 关键词向量                                                       │   │
│  │                                                                       │   │
│  │  Payload 结构：                                                       │   │
│  │  {                                                                    │   │
│  │    chunkId: string,                                                   │   │
│  │    documentId: string,                                                │   │
│  │    assistantId: string,                                               │   │
│  │    content: string,           // 原始内容                             │   │
│  │    summary: string,           // AI 生成的摘要                        │   │
│  │    keywords: string[],        // 关键词                               │   │
│  │    chunkType: string,         // 块类型（定义/条款/示例）             │   │
│  │    metadata: object           // 其他元数据                           │   │
│  │  }                                                                    │   │
│  │                                                                       │   │
│  │  特点：                                                               │   │
│  │  • 高效向量检索                                                       │   │
│  │  • 支持过滤条件                                                       │   │
│  │  • 可扩展性好                                                         │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         文件系统 (原始文件)                           │   │
│  │                                                                       │   │
│  │  存储内容：                                                           │   │
│  │  • 上传的原始文档                                                     │   │
│  │  • 处理后的文本文件                                                   │   │
│  │                                                                       │   │
│  │  目录结构：                                                           │   │
│  │  data/                                                                │   │
│  │  ├── uploads/                 # 原始上传文件                          │   │
│  │  │   └── {assistantId}/                                               │   │
│  │  │       └── {documentId}/                                            │   │
│  │  └── processed/               # 处理后的文件                          │   │
│  │      └── {assistantId}/                                               │   │
│  │          └── {documentId}/                                            │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 向量化策略

#### 传统方式 vs Agentic 方式

| 方面 | 传统方式 | Agentic 方式 |
|------|----------|--------------|
| 分块 | 固定字符数（如 1000 字符） | AI 角色语义分块 |
| 向量化内容 | 原始文本 | 原始文本 + AI 摘要 |
| 元数据 | 基础信息（位置、页码） | 丰富信息（类型、关键词、实体） |
| 检索 | 纯向量相似度 | 向量 + 元数据过滤 + 角色理解 |

#### 双向量策略

为每个文档块存储两种向量：

1. **原始内容向量**：保留原始信息，用于精确匹配
2. **AI 摘要向量**：捕获语义，用于概念匹配

```typescript
interface DocumentChunk {
  id: string;
  documentId: string;

  // 原始内容
  content: string;
  contentVector: number[];

  // AI 生成的摘要
  summary: string;
  summaryVector: number[];

  // 元数据
  metadata: {
    chunkIndex: number;
    chunkType: 'definition' | 'clause' | 'example' | 'general';
    keywords: string[];
    entities: string[];
    pageNumber?: number;
    section?: string;
  };
}
```

---

## 6. 实现路线图

### 6.1 Phase 1: 基础 Agentic 能力 (MVP)

- [ ] 助手（主角色）框架实现
- [ ] 文档处理子代理（基础版）
- [ ] 检索子代理（基础版）
- [ ] PromptX MCP 集成
- [ ] Agent 框架集成
- [ ] 基础记忆系统

### 6.2 Phase 2: 增强 Agentic 能力

- [ ] 智能语义分块
- [ ] 双向量存储
- [ ] 领域专家子代理
- [ ] 记忆网络优化
- [ ] 子代理自动选择

### 6.3 Phase 3: 高级 Agentic 能力

- [ ] 多子代理协作
- [ ] 自定义子代理创建
- [ ] 持续学习优化
- [ ] 子代理性能分析

---

## 7. 与其他文档的关系

| 文档 | 关系 |
|------|------|
| [ARCHITECTURE-DESIGN.md](./ARCHITECTURE-DESIGN.md) | 本文档补充其 Agentic 架构部分 |
| [TECHNICAL-ARCHITECTURE.md](./TECHNICAL-ARCHITECTURE.md) | 本文档定义 PromptX/Agent 集成层 |
| [SPEC-003 文档处理](../SPEC-003-DOCUMENT-PROCESSING.md) | 本文档定义 Agentic 处理流程 |
| [SPEC-004 对话系统](../SPEC-004-CONVERSATION-SYSTEM.md) | 本文档定义助手/子代理协作 |
| [SPEC-005 角色记忆](../SPEC-005-ROLE-MEMORY.md) | 本文档定义角色体系和记忆机制 |

---

## 修订历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2024-12-17 | 初始版本，定义 Agentic 多角色架构 |
| 2.0.0 | 2024-12-17 | 更新术语：子角色→子代理，明确 PromptX/Agent 分工 |
