# 技术架构设计

> **版本**: 2.0.0
> **状态**: Draft
> **最后更新**: 2024-12-17

---

## 1. 概述

本文档定义系统的技术架构，包括分层设计、组件交互、技术选型和部署方案。

> **重要**: 本文档已更新以反映实际实现。关于 Agentic 多角色架构的详细设计，请参阅 [AGENTIC-ARCHITECTURE.md](./AGENTIC-ARCHITECTURE.md)。

### 架构目标

| 目标 | 描述 |
|------|------|
| 简单 | MVP 阶段保持简单，避免过度设计 |
| 可扩展性 | 架构支持后续扩展（多租户、分布式） |
| 可维护性 | 清晰的分层，易于理解和修改 |
| 高性能 | 流式响应，异步处理 |

---

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AgentX Agentic RAG System                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         前端层 (Client)                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │   React 18  │  │   Vite 6    │  │  Tailwind   │  │  Zustand   │  │   │
│  │  │             │  │             │  │   CSS 4     │  │            │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                          HTTP / SSE │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         后端层 (Server)                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │    Hono     │  │    JWT      │  │    Pino     │  │   Zod      │  │   │
│  │  │  (Web框架)  │  │   (认证)    │  │   (日志)    │  │  (验证)    │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       服务层 (Services)                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │  Assistant  │  │  Document   │  │Conversation │  │    RAG     │  │   │
│  │  │  Service    │  │  Service    │  │  Service    │  │  Service   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      PromptX 集成层 (Agentic)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │    MCP      │  │    Role     │  │   Memory    │  │   Tool     │  │   │
│  │  │  Protocol   │  │  Manager    │  │   System    │  │  Runtime   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  │                                                                       │   │
│  │  详见: AGENTIC-ARCHITECTURE.md                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      数据处理层 (Processing)                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │  Extractor  │  │   Chunker   │  │  Embedder   │  │  Retriever │  │   │
│  │  │ (文本提取)  │  │  (智能分块) │  │  (向量化)   │  │  (检索)    │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         存储层 (Storage)                             │   │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────┐   │   │
│  │  │        SQLite           │  │           Qdrant                │   │   │
│  │  │   (关系数据 + 文件)     │  │        (向量数据)               │   │   │
│  │  │  - users                │  │  - document_vectors             │   │   │
│  │  │  - assistants           │  │    - chunkId                    │   │   │
│  │  │  - documents            │  │    - documentId                 │   │   │
│  │  │  - conversations        │  │    - assistantId                │   │   │
│  │  │  - messages             │  │    - content                    │   │   │
│  │  │  - roles                │  │    - summary                    │   │   │
│  │  │  - memories             │  │                                 │   │   │
│  │  └─────────────────────────┘  └─────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        外部服务 (External)                           │   │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────┐   │   │
│  │  │      Claude API         │  │      OpenAI Embeddings          │   │   │
│  │  │      (对话生成)         │  │        (文本向量化)             │   │   │
│  │  └─────────────────────────┘  └─────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 技术选型

### 3.1 后端技术栈

| 组件 | 技术 | 版本 | 选择理由 |
|------|------|------|----------|
| 运行时 | Node.js | 20.x LTS | 稳定、生态丰富 |
| 语言 | TypeScript | 5.x | 类型安全、开发体验好 |
| Web 框架 | **Hono** | 4.x | 轻量（14KB）、TypeScript 原生、支持多运行时 |
| 数据库 | **SQLite** | - | MVP 简单、无需额外服务、better-sqlite3 高性能 |
| 向量库 | **Qdrant** | 1.x | 专业向量数据库、支持过滤、REST API |
| 认证 | **jose** | 5.x | JWT 标准库、安全 |
| 密码 | **bcrypt** | 5.x | 行业标准、安全 |
| 日志 | **Pino** | 8.x | 高性能、结构化日志 |
| 验证 | **Zod** | 3.x | TypeScript 原生、运行时验证 |
| 文档解析 | pdf-parse, mammoth | - | 成熟的解析库 |
| 嵌入 | OpenAI Embeddings | - | 高质量向量、text-embedding-3-small |
| LLM | Claude API | - | 强大的对话能力 |

### 3.2 前端技术栈

| 组件 | 技术 | 版本 | 选择理由 |
|------|------|------|----------|
| 框架 | **React** | 18.x | 生态成熟、组件化 |
| 构建 | **Vite** | 6.x | 快速开发体验、HMR |
| 样式 | **Tailwind CSS** | 4.x | 原子化 CSS、快速开发 |
| 状态 | **Zustand** | 4.x | 简单、轻量、TypeScript 友好 |
| 路由 | **React Router** | 7.x | 标准路由方案 |
| 请求 | **TanStack Query** | 5.x | 服务端状态管理、缓存 |
| 图标 | **Lucide React** | - | 轻量、美观 |

### 3.3 数据存储

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 主数据库 | **SQLite** | - | 关系数据存储（MVP 阶段） |
| 向量数据库 | **Qdrant** | 1.x | 向量存储和检索 |
| 文件存储 | 本地文件系统 | - | 文档文件存储 |

> **注意**: MVP 阶段不使用 Redis 缓存，后期可按需添加。

### 3.4 AI/ML 组件

| 组件 | 技术 | 用途 |
|------|------|------|
| LLM | Claude API | 对话生成 |
| 嵌入 | OpenAI Embeddings | 文本向量化 (text-embedding-3-small) |
| 角色系统 | **PromptX MCP** | 角色和记忆管理 |

### 3.5 技术选型对比

#### Hono vs Express vs Fastify

| 特性 | Hono | Express | Fastify |
|------|------|---------|---------|
| 大小 | 14KB | 200KB+ | 100KB+ |
| TypeScript | 原生 | 需要 @types | 原生 |
| 性能 | 极高 | 中等 | 高 |
| 多运行时 | ✅ | ❌ | ❌ |
| 学习曲线 | 低 | 低 | 中 |

**选择 Hono 的理由**：轻量、TypeScript 原生、与参考项目一致。

#### SQLite vs PostgreSQL

| 特性 | SQLite | PostgreSQL |
|------|--------|------------|
| 部署复杂度 | 零（文件） | 需要服务 |
| 性能 | 单机高 | 分布式高 |
| 并发 | 有限 | 高 |
| 适用场景 | MVP、单机 | 生产、多实例 |

**选择 SQLite 的理由**：MVP 阶段简单，后期可迁移到 PostgreSQL。

---

## 4. 数据流

> **详细的 Agentic 数据流设计请参阅 [AGENTIC-ARCHITECTURE.md](./AGENTIC-ARCHITECTURE.md)**

### 4.1 用户提问流程 (Agentic)

```
用户输入 → 主角色分析 → 任务委派 → 子角色执行 → 结果整合 → 流式输出
    │           │            │           │           │
    │           ▼            ▼           ▼           ▼
    │      意图分析      检索角色    向量检索    记忆保存
    │                   领域专家    记忆回忆
    │                              │           │
    ◄──────────────────────────────┴───────────┘
                    SSE 流式响应
```

### 4.2 文档处理流程 (Agentic)

```
上传文件 → 文档处理角色 → 智能分块 → 信息增强 → 向量嵌入 → 索引存储
              │              │           │
              ▼              ▼           ▼
         文档类型识别    语义边界分块   生成摘要
         结构理解        保持上下文     提取关键词
```

---

## 5. 目录结构

```
agentic-rag/
├── apps/
│   └── web/                          # 主应用（前后端一体）
│       ├── src/
│       │   ├── client/               # 前端代码
│       │   │   ├── components/       # UI 组件
│       │   │   ├── hooks/            # 自定义 Hooks
│       │   │   ├── stores/           # Zustand 状态
│       │   │   ├── services/         # API 服务
│       │   │   ├── App.tsx           # 应用入口
│       │   │   └── main.tsx          # 渲染入口
│       │   │
│       │   └── server/               # 后端代码
│       │       ├── routes/           # API 路由
│       │       ├── services/         # 业务服务
│       │       ├── repositories/     # 数据访问层
│       │       ├── database/         # 数据库初始化
│       │       ├── middleware/       # 中间件
│       │       ├── validators/       # 数据验证
│       │       ├── errors/           # 错误处理
│       │       ├── processing/       # 文档处理（待实现）
│       │       ├── retrieval/        # 向量检索（待实现）
│       │       ├── agentic/          # Agentic 角色系统（待实现）
│       │       ├── utils/            # 工具函数
│       │       └── index.ts          # 服务器入口
│       │
│       ├── public/                   # 静态文件
│       ├── index.html                # HTML 模板
│       ├── vite.config.ts            # Vite 配置
│       ├── vitest.config.ts          # 测试配置
│       ├── tailwind.config.ts        # Tailwind 配置
│       ├── tsconfig.json             # TypeScript 配置
│       └── package.json
│
├── packages/
│   └── shared/                       # 共享包
│       ├── src/
│       │   ├── types/                # 共享类型定义
│       │   └── constants/            # 共享常量
│       └── package.json
│
├── spec/                             # 规格文档
│   ├── SPEC-*.md                     # 需求规格
│   ├── design/                       # 设计文档
│   └── features/                     # Gherkin 特性文件
│
├── openspec/                         # OpenSpec 变更管理
│   ├── changes/                      # 活跃变更
│   └── specs/                        # 已归档规格
│
├── data/                             # 数据目录（gitignore）
│   ├── agentic-rag.db                # SQLite 数据库
│   ├── uploads/                      # 上传文件
│   └── logs/                         # 日志文件
│
├── docker-compose.yml                # Docker 编排（Qdrant）
├── .env.example                      # 环境变量示例
├── .gitignore
├── package.json                      # 根 package.json
├── pnpm-workspace.yaml               # pnpm 工作区配置
└── README.md
```

---

## 6. 部署架构

### 6.1 Docker Compose (开发环境)

```yaml
version: '3.8'

services:
  # Qdrant 向量数据库
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"    # REST API
      - "6334:6334"    # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334

volumes:
  qdrant_data:
```

> **注意**: 开发环境中，Web 应用直接通过 `pnpm dev` 运行，不需要 Docker 化。

### 6.2 环境配置

| 环境 | 用途 | 配置 |
|------|------|------|
| development | 本地开发 | SQLite + Qdrant Docker |
| staging | 测试环境 | 模拟生产配置 |
| production | 生产环境 | PostgreSQL + Qdrant Cloud |

### 6.3 环境变量

```bash
# 服务器配置
PORT=3000
NODE_ENV=development

# 数据库
DATABASE_PATH=./data/agentic-rag.db

# 向量数据库
QDRANT_URL=http://localhost:6333

# AI 服务
ANTHROPIC_API_KEY=your-anthropic-api-key
OPENAI_API_KEY=your-openai-api-key

# 认证
JWT_SECRET=your-jwt-secret
API_KEY=your-api-key

# 嵌入模型
EMBEDDING_MODEL=text-embedding-3-small
EMBEDDING_DIMENSIONS=1536
```

---

## 7. 性能指标

| 指标 | 目标值 | 测量方式 |
|------|--------|----------|
| API 响应时间 | < 2s (P95) | APM 监控 |
| 对话首字节时间 | < 3s | 前端埋点 |
| 文档处理速度 | < 30s/MB | 后台任务监控 |
| 系统可用性 | > 99% | 健康检查 |

---

## 8. 安全设计

### 8.1 认证授权

- JWT Token 认证
- API Key 认证（MVP 阶段简化）
- 基于角色的访问控制 (RBAC)（后期）

### 8.2 数据安全

- 传输加密 (HTTPS/TLS)
- 敏感数据加密存储
- 用户数据隔离

### 8.3 安全防护

- 请求频率限制
- SQL 注入防护（参数化查询）
- XSS 防护

---

## 9. 相关文档

| 文档 | 描述 |
|------|------|
| [AGENTIC-ARCHITECTURE.md](./AGENTIC-ARCHITECTURE.md) | Agentic 多角色架构详细设计 |
| [ARCHITECTURE-DESIGN.md](./ARCHITECTURE-DESIGN.md) | 整体架构设计 |
| [DATA-MODEL.md](./DATA-MODEL.md) | 数据模型设计 |
| [API-REFERENCE.md](./API-REFERENCE.md) | API 参考文档 |

---

## 修订历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2024-12-16 | 初始版本 |
| 2.0.0 | 2024-12-17 | 更新技术栈（Hono/SQLite），添加 Agentic 架构引用 |
