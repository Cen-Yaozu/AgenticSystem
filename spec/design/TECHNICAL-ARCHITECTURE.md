# 技术架构设计

> **版本**: 1.0.0  
> **状态**: Draft  
> **最后更新**: 2024-12-16

---

## 1. 概述

本文档定义系统的技术架构，包括分层设计、组件交互、技术选型和部署方案。

### 架构目标

| 目标 | 描述 |
|------|------|
| 可扩展性 | 支持水平扩展，应对用户增长 |
| 可维护性 | 模块化设计，易于维护和升级 |
| 可靠性 | 故障隔离，优雅降级 |
| 性能 | 低延迟响应，高吞吐量 |

---

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              系统架构图                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         前端层 (Frontend)                            │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │   React     │  │   Vite      │  │  TanStack   │  │  Tailwind  │  │   │
│  │  │   18.x      │  │   5.x       │  │   Query     │  │    CSS     │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         API 网关层 (Gateway)                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │   Fastify   │  │    CORS     │  │  Rate Limit │  │   Auth     │  │   │
│  │  │   4.x       │  │   Handler   │  │   Handler   │  │  Handler   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       应用服务层 (Services)                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │  Assistant  │  │  Document   │  │Conversation │  │   Role     │  │   │
│  │  │  Service    │  │  Service    │  │  Service    │  │  Service   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      AgentX 运行时层 (Runtime)                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │   AgentX    │  │  SystemBus  │  │   Mealy     │  │   Agent    │  │   │
│  │  │   Runtime   │  │   Events    │  │  Machine    │  │  Manager   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      PromptX 集成层 (Integration)                    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │    MCP      │  │    Role     │  │   Memory    │  │   Tool     │  │   │
│  │  │  Protocol   │  │  Manager    │  │   System    │  │  Runtime   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       数据处理层 (Processing)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │  Document   │  │  Embedding  │  │   Vector    │  │  Retrieval │  │   │
│  │  │  Processor  │  │  Service    │  │   Engine    │  │   Engine   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         存储层 (Storage)                             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │ PostgreSQL  │  │   Qdrant    │  │    Redis    │  │    File    │  │   │
│  │  │   (主库)    │  │  (向量库)   │  │   (缓存)    │  │  Storage   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 技术选型

### 3.1 后端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 运行时 | Node.js | 20.x LTS | JavaScript 运行环境 |
| 语言 | TypeScript | 5.x | 类型安全 |
| Web 框架 | Fastify | 4.x | HTTP 服务器 |
| ORM | Prisma | 5.x | 数据库访问 |
| 验证 | Zod | 3.x | 请求验证 |
| 日志 | Pino | 8.x | 结构化日志 |

### 3.2 前端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 框架 | React | 18.x | UI 框架 |
| 构建 | Vite | 5.x | 构建工具 |
| 状态 | TanStack Query | 5.x | 服务端状态 |
| 状态 | Zustand | 4.x | 客户端状态 |
| 样式 | Tailwind CSS | 3.x | CSS 框架 |
| 路由 | React Router | 6.x | 路由管理 |

### 3.3 数据存储

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 主数据库 | PostgreSQL | 15.x | 关系数据存储 |
| 向量数据库 | Qdrant | 1.x | 向量存储和检索 |
| 缓存 | Redis | 7.x | 缓存和会话 |
| 文件存储 | 本地/S3 | - | 文档文件存储 |

### 3.4 AI/ML 组件

| 组件 | 技术 | 用途 |
|------|------|------|
| LLM | Claude API | 对话生成 |
| 嵌入 | OpenAI Embeddings | 文本向量化 |
| 框架 | AgentX | Agent 运行时 |
| 角色 | PromptX | 角色和记忆管理 |

---

## 4. 数据流

### 4.1 用户提问流程

```
用户输入 → API网关 → 服务层 → AgentX Runtime → PromptX MCP → Claude API
    │                              │                │
    │                              ▼                ▼
    │                         向量检索          记忆系统
    │                              │                │
    │                              ▼                ▼
    │                         上下文组装
    │                              │
    ◄──────────────────────────────┘
              SSE 流式响应
```

### 4.2 文档处理流程

```
上传文件 → 文件验证 → 文本提取 → 智能分块 → 向量嵌入 → 索引存储
```

---

## 5. 目录结构

```
agentic-rag-system/
├── packages/
│   ├── backend/
│   │   ├── src/
│   │   │   ├── api/              # API 路由
│   │   │   ├── services/         # 业务服务
│   │   │   ├── agents/           # AgentX 集成
│   │   │   ├── promptx/          # PromptX 集成
│   │   │   ├── processing/       # 文档处理
│   │   │   ├── retrieval/        # 向量检索
│   │   │   ├── models/           # 数据模型
│   │   │   └── utils/            # 工具函数
│   │   ├── prisma/
│   │   └── package.json
│   │
│   ├── frontend/
│   │   ├── src/
│   │   │   ├── components/       # UI 组件
│   │   │   ├── pages/            # 页面
│   │   │   ├── hooks/            # 自定义 Hooks
│   │   │   ├── services/         # API 服务
│   │   │   ├── stores/           # 状态管理
│   │   │   └── utils/            # 工具函数
│   │   └── package.json
│   │
│   └── shared/                   # 共享代码
│       └── src/types/            # 类型定义
│
├── spec/                         # 规格文档
├── docker-compose.yml
└── package.json
```

---

## 6. 部署架构

### 6.1 Docker Compose

```yaml
version: '3.8'

services:
  backend:
    build: ./packages/backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/agentic_rag
      - REDIS_URL=redis://redis:6379
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - postgres
      - redis
      - qdrant

  frontend:
    build: ./packages/frontend
    ports:
      - "5173:80"
    depends_on:
      - backend

  postgres:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  qdrant:
    image: qdrant/qdrant:latest
    volumes:
      - qdrant_data:/qdrant/storage

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
```

### 6.2 环境配置

| 环境 | 用途 | 配置 |
|------|------|------|
| development | 本地开发 | 单实例，调试模式 |
| staging | 测试环境 | 模拟生产配置 |
| production | 生产环境 | 高可用，监控告警 |

---

## 7. 性能指标

| 指标 | 目标值 | 测量方式 |
|------|--------|----------|
| API 响应时间 | < 2s (P95) | APM 监控 |
| 对话首字节时间 | < 3s | 前端埋点 |
| 文档处理速度 | < 30s/MB | 后台任务监控 |
| 系统可用性 | > 99% | 健康检查 |

---

## 8. 安全设计

### 8.1 认证授权

- JWT Token 认证
- 基于角色的访问控制 (RBAC)
- API 密钥管理

### 8.2 数据安全

- 传输加密 (HTTPS/TLS)
- 敏感数据加密存储
- 用户数据隔离

### 8.3 安全防护

- 请求频率限制
- SQL 注入防护
- XSS 防护

---

## 修订历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2024-12-16 | 从 SPEC-008 提取，独立为设计文档 |