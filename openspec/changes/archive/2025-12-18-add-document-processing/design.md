# Design: æ–‡æ¡£å¤„ç†ç³»ç»Ÿ

## Context

æœ¬é¡¹ç›®éœ€è¦å®ç°æ–‡æ¡£å¤„ç†åŠŸèƒ½ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿä¸Šä¼ ä¸“ä¸šæ–‡æ¡£ç»™åŠ©æ‰‹å­¦ä¹ ã€‚

### ğŸ¯ å¤ç”¨ç­–ç•¥

**é‡è¦å‘ç°**ï¼š`promptx-agenticRag/collector` å·²æœ‰æˆç†Ÿçš„æ–‡æ¡£å¤„ç†å®ç°ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ï¼

| ç»„ä»¶ | æ¥æº | å¤ç”¨æ–¹å¼ |
|------|------|----------|
| PDF è§£æ | `collector/processSingleFile/convert/asPDF/` | å¤ç”¨ PDFLoader + OCR å›é€€ |
| DOCX è§£æ | `collector/processSingleFile/convert/asDocx.js` | å¤ç”¨ langchain DocxLoader |
| XLSX è§£æ | `collector/processSingleFile/convert/asXlsx.js` | å¤ç”¨ node-xlsx |
| TXT/MD è§£æ | `collector/processSingleFile/convert/asTxt.js` | å¤ç”¨ç›´æ¥è¯»å–é€»è¾‘ |
| æ–‡ä»¶ç±»å‹æ£€æµ‹ | `collector/utils/constants.js` | å¤ç”¨ SUPPORTED_FILETYPE_CONVERTERS |
| Token è®¡ç®— | `collector/utils/tokenizer.js` | å¤ç”¨ tokenizeString |

### ä¾èµ–åº“ï¼ˆä» collector å¤ç”¨ï¼‰
```json
{
  "pdf-parse": "^1.1.1",
  "mammoth": "^1.6.0",           // æˆ–ä½¿ç”¨ langchain DocxLoader
  "node-xlsx": "^0.24.0",
  "langchain": "0.1.36",
  "@langchain/community": "^0.2.23"
}
```

### çº¦æŸæ¡ä»¶
- MVP é˜¶æ®µä½¿ç”¨å›ºå®šå­—ç¬¦åˆ†å—ï¼ˆ1000 å­—ç¬¦/å—ï¼Œ100 å­—ç¬¦é‡å ï¼‰
- å•æ–‡æ¡£æœ€å¤§ 10MB
- æ¯ä¸ªåŠ©æ‰‹æœ€å¤š 100 ä¸ªæ–‡æ¡£
- å¤„ç†å¤±è´¥æœ€å¤šé‡è¯• 3 æ¬¡

## Goals / Non-Goals

### Goals
- **å¤ç”¨ promptx-agenticRag/collector çš„æ–‡æ¡£è§£æé€»è¾‘**
- å®ç°å®Œæ•´çš„æ–‡æ¡£ä¸Šä¼ å’Œå¤„ç†æµæ°´çº¿
- æ”¯æŒ PDFã€DOCXã€TXTã€MDã€XLSX æ ¼å¼
- æä¾›æ–‡æ¡£ç®¡ç† APIï¼ˆCRUDï¼‰
- å®ç°å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ
- å¤„ç†çŠ¶æ€å®æ—¶æ›´æ–°

### Non-Goals
- æ™ºèƒ½è¯­ä¹‰åˆ†å—ï¼ˆPhase 2ï¼‰
- å›¾ç‰‡ OCRï¼ˆPhase 3ï¼‰- collector å·²æœ‰å®ç°ï¼Œå¯åç»­å¯ç”¨
- å¤šè¯­è¨€æ”¯æŒï¼ˆPhase 3ï¼‰
- å¢é‡æ›´æ–°ï¼ˆPhase 3ï¼‰

## Decisions

### Decision 1: æ–‡æœ¬æå–æ–¹å¼ï¼ˆæ›´æ–°ï¼‰

**é€‰æ‹©**ï¼šå¤ç”¨ promptx-agenticRag/collector çš„è§£æé€»è¾‘ï¼Œè€Œé PromptX å·¥å…·

**åŸå› **ï¼š
- collector å·²æœ‰æˆç†Ÿã€ç»è¿‡éªŒè¯çš„å®ç°
- ç›´æ¥ä½¿ç”¨ npm åŒ…ï¼Œæ— éœ€ MCP åè®®å¼€é”€
- æ”¯æŒæ›´å¤šæ ¼å¼ï¼ˆPDF OCR å›é€€ã€Excel å¤š sheetï¼‰
- ä»£ç å¯ç›´æ¥å¤åˆ¶æˆ–ä½œä¸ºå…±äº«åŒ…

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- PromptX å·¥å…·ï¼ˆpdf-reader, word-toolï¼‰- å¢åŠ  MCP è°ƒç”¨å¤æ‚åº¦

### Decision 2: æ–‡æ¡£å­˜å‚¨ä½ç½®

**é€‰æ‹©**ï¼šæ–‡æ¡£å­˜å‚¨åœ¨åŠ©æ‰‹å·¥ä½œåŒºç›®å½• `workspaces/{assistantId}/documents/`

**åŸå› **ï¼š
- ä¸ç°æœ‰å·¥ä½œåŒºç»“æ„ä¸€è‡´
- ä¾¿äºç®¡ç†å’Œæ¸…ç†
- åˆ é™¤åŠ©æ‰‹æ—¶å¯ä»¥ä¸€å¹¶æ¸…ç†

### Decision 3: å‘é‡å­˜å‚¨ç­–ç•¥

**é€‰æ‹©**ï¼šæ¯ä¸ªåŠ©æ‰‹å¯¹åº”ä¸€ä¸ª Qdrant collectionï¼Œå‘½åä¸º `assistant_{assistantId}`

**åŸå› **ï¼š
- éš”ç¦»ä¸åŒåŠ©æ‰‹çš„æ•°æ®
- ä¾¿äºåˆ é™¤åŠ©æ‰‹æ—¶æ¸…ç†å‘é‡æ•°æ®
- æŸ¥è¯¢æ—¶æ— éœ€é¢å¤–è¿‡æ»¤

### Decision 4: å‘é‡åŒ–æ–¹å¼

**é€‰æ‹©**ï¼šç›´æ¥è°ƒç”¨ OpenAI Embedding APIï¼ˆtext-embedding-3-smallï¼‰

**åŸå› **ï¼š
- ç®€å•ç›´æ¥ï¼ŒMVP é˜¶æ®µè¶³å¤Ÿ
- 1536 ç»´å‘é‡ï¼Œæ€§èƒ½å’Œæ•ˆæœå¹³è¡¡
- æˆæœ¬è¾ƒä½

### Decision 5: å¤„ç†æµç¨‹æ¶æ„

**é€‰æ‹©**ï¼šåŒæ­¥å¤„ç† + çŠ¶æ€æ›´æ–°

**åŸå› **ï¼š
- MVP é˜¶æ®µç®€å•å¯é 
- é€šè¿‡æ•°æ®åº“çŠ¶æ€è·Ÿè¸ªè¿›åº¦
- å¤±è´¥å¯é‡è¯•

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ–‡æ¡£å¤„ç†æ¶æ„ï¼ˆå¤ç”¨ collectorï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Client    â”‚â”€â”€â”€â”€â–¶â”‚  Documents API  â”‚â”€â”€â”€â”€â–¶â”‚ Document Serviceâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                        â”‚                    â”‚
â”‚                                                        â–¼                    â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                              â”‚   Processor     â”‚           â”‚
â”‚                                              â”‚   Service       â”‚           â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                       â”‚                    â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                      â”‚                                â”‚                â”‚   â”‚
â”‚                      â–¼                                â–¼                â–¼   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚              â”‚ File Parsers  â”‚              â”‚ Embedding   â”‚    â”‚ Qdrant  â”‚ â”‚
â”‚              â”‚ (from collector)             â”‚ API         â”‚    â”‚ Service â”‚ â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚              â”‚ pdf-parse     â”‚  â† å¤ç”¨ collector ä¾èµ–                       â”‚
â”‚              â”‚ DocxLoader    â”‚                                             â”‚
â”‚              â”‚ node-xlsx     â”‚                                             â”‚
â”‚              â”‚ fs.readFile   â”‚                                             â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¤ç”¨ä»£ç æ¸…å•

### ä» collector å¤ç”¨çš„æ ¸å¿ƒæ–‡ä»¶

```
promptx-agenticRag/collector/
â”œâ”€â”€ processSingleFile/
â”‚   â”œâ”€â”€ index.js                    # æ–‡ä»¶å¤„ç†å…¥å£é€»è¾‘
â”‚   â””â”€â”€ convert/
â”‚       â”œâ”€â”€ asPDF/index.js          # PDF è§£æ + OCR å›é€€
â”‚       â”œâ”€â”€ asDocx.js               # DOCX è§£æ
â”‚       â”œâ”€â”€ asXlsx.js               # XLSX è§£æï¼ˆå¤š sheet æ”¯æŒï¼‰
â”‚       â””â”€â”€ asTxt.js                # TXT/MD è§£æ
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ constants.js                # SUPPORTED_FILETYPE_CONVERTERS
â”‚   â”œâ”€â”€ tokenizer.js                # tokenizeString
â”‚   â””â”€â”€ files.js                    # æ–‡ä»¶æ“ä½œå·¥å…·
```

### é€‚é…ä¿®æ”¹

1. **ç§»é™¤ writeToServerDocuments** - æ”¹ä¸ºè¿”å›æå–çš„æ–‡æœ¬
2. **ç§»é™¤ trashFile** - ç”±ä¸Šå±‚æœåŠ¡ç®¡ç†æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸ
3. **TypeScript é‡å†™** - ä¿æŒé¡¹ç›®ä¸€è‡´æ€§
4. **ç®€åŒ–å…ƒæ•°æ®** - åªä¿ç•™å¿…è¦å­—æ®µ

## Data Flow

```
1. ä¸Šä¼ é˜¶æ®µ
   Client â†’ POST /api/assistants/:id/documents
         â†’ éªŒè¯æ–‡ä»¶ï¼ˆå¤§å°ã€ç±»å‹ï¼‰
         â†’ ä¿å­˜åˆ° workspaces/{assistantId}/documents/
         â†’ åˆ›å»º documents è®°å½•ï¼ˆstatus: queuedï¼‰
         â†’ è¿”å› document ID

2. å¤„ç†é˜¶æ®µï¼ˆå¼‚æ­¥ï¼‰
   Processor â†’ è¯»å–æ–‡ä»¶
            â†’ è°ƒç”¨å¤ç”¨çš„è§£æå™¨æå–æ–‡æœ¬
            â†’ æ¸…ç†æ–‡æœ¬
            â†’ åˆ†å—ï¼ˆ1000 å­—ç¬¦/å—ï¼‰
            â†’ è°ƒç”¨ Embedding API å‘é‡åŒ–
            â†’ å­˜å‚¨åˆ° Qdrant
            â†’ æ›´æ–° documents è®°å½•ï¼ˆstatus: completedï¼‰

3. æŸ¥è¯¢é˜¶æ®µ
   Client â†’ GET /api/assistants/:id/documents
         â†’ è¿”å›æ–‡æ¡£åˆ—è¡¨ï¼ˆå«çŠ¶æ€ï¼‰

4. åˆ é™¤é˜¶æ®µ
   Client â†’ DELETE /api/assistants/:id/documents/:docId
         â†’ åˆ é™¤ Qdrant ä¸­çš„å‘é‡
         â†’ åˆ é™¤æ–‡ä»¶
         â†’ åˆ é™¤ documents è®°å½•
```

## Risks / Trade-offs

### Risk 1: collector ä»£ç è€¦åˆ
- **å½±å“**ï¼šç›´æ¥å¤åˆ¶å¯èƒ½å¯¼è‡´ä»£ç é‡å¤
- **ç¼“è§£**ï¼šè€ƒè™‘åç»­æŠ½å–ä¸ºå…±äº«åŒ… `@agentic-rag/document-parser`

### Risk 2: Embedding API é™æµ
- **å½±å“**ï¼šå‘é‡åŒ–å»¶è¿Ÿ
- **ç¼“è§£**ï¼šæ‰¹é‡å¤„ç†ï¼Œæ·»åŠ å»¶è¿Ÿ

### Risk 3: å¤§æ–‡ä»¶å¤„ç†è¶…æ—¶
- **å½±å“**ï¼šå¤„ç†å¤±è´¥
- **ç¼“è§£**ï¼šé™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰ï¼Œåˆ†å—å¤„ç†

## API Design

### ä¸Šä¼ æ–‡æ¡£
```
POST /api/assistants/:assistantId/documents
Content-Type: multipart/form-data

Response: 201 Created
{
  "id": "doc_xxxxxxxx",
  "filename": "contract.pdf",
  "fileType": "pdf",
  "fileSize": 1048576,
  "status": "queued",
  "progress": 0
}
```

### è·å–æ–‡æ¡£åˆ—è¡¨
```
GET /api/assistants/:assistantId/documents?status=completed&page=1&limit=10

Response: 200 OK
{
  "data": [...],
  "pagination": { "page": 1, "limit": 10, "total": 5 }
}
```

### è·å–æ–‡æ¡£è¯¦æƒ…
```
GET /api/assistants/:assistantId/documents/:documentId

Response: 200 OK
{
  "id": "doc_xxxxxxxx",
  "filename": "contract.pdf",
  "fileType": "pdf",
  "fileSize": 1048576,
  "status": "completed",
  "progress": 100,
  "chunkCount": 15,
  "uploadedAt": "2024-12-17T10:00:00Z",
  "processedAt": "2024-12-17T10:01:30Z"
}
```

### åˆ é™¤æ–‡æ¡£
```
DELETE /api/assistants/:assistantId/documents/:documentId

Response: 204 No Content
```

### é‡æ–°å¤„ç†æ–‡æ¡£
```
POST /api/assistants/:assistantId/documents/:documentId/reprocess

Response: 202 Accepted
{
  "id": "doc_xxxxxxxx",
  "status": "queued"
}
```

## Open Questions

1. ~~æ˜¯å¦éœ€è¦ WebSocket å®æ—¶æ¨é€å¤„ç†è¿›åº¦ï¼Ÿ~~ â†’ MVP é˜¶æ®µä½¿ç”¨è½®è¯¢ï¼Œåç»­å¯æ‰©å±•
2. ~~æ˜¯å¦éœ€è¦æ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼Ÿ~~ â†’ P1 åŠŸèƒ½ï¼ŒMVP é˜¶æ®µå•æ–‡ä»¶ä¸Šä¼ 
3. ~~æ˜¯å¦ä½¿ç”¨ PromptX å·¥å…·ï¼Ÿ~~ â†’ **å†³å®šå¤ç”¨ collector ä»£ç ï¼Œæ›´ç®€å•é«˜æ•ˆ**
