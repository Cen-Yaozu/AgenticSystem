# Design: é›†æˆ @agentxjs/ui åŒ…

**Status: ğŸ”„ In Progress (æ¢å¤è‡ªå½’æ¡£)**

## Context

å½“å‰é¡¹ç›®çš„èŠå¤© UI ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶ï¼Œç¼ºå°‘ Markdown æ¸²æŸ“ã€ä»£ç é«˜äº®ç­‰åŠŸèƒ½ã€‚AgentX é¡¹ç›®æä¾›äº†æˆç†Ÿçš„ UI ç»„ä»¶åº“ `@agentxjs/ui`ï¼Œé‡‡ç”¨ Conversation-first, Block-based è®¾è®¡ã€‚

### çº¦æŸæ¡ä»¶
- éœ€è¦ä¿æŒä¸ç°æœ‰åç«¯ API çš„å…¼å®¹æ€§
- éœ€è¦é€‚é…ç°æœ‰çš„ WebSocket äº‹ä»¶æ ¼å¼
- éœ€è¦ä¸ç°æœ‰çš„é¢†åŸŸç®¡ç†ã€æ–‡æ¡£ç®¡ç† UI é£æ ¼ä¸€è‡´

### åˆ©ç›Šç›¸å…³è€…
- ç”¨æˆ·ï¼šéœ€è¦æ›´å¥½çš„æ¶ˆæ¯å±•ç¤ºä½“éªŒï¼ˆMarkdownã€ä»£ç é«˜äº®ï¼‰
- å¼€å‘è€…ï¼šéœ€è¦å¯ç»´æŠ¤çš„ç»„ä»¶åº“ï¼Œä¾¿äºåç»­å‡çº§

## Goals / Non-Goals

### Goals
- é›†æˆ @agentxjs/ui ç»„ä»¶åº“
- æ”¯æŒ Markdown æ¸²æŸ“å’Œä»£ç é«˜äº®
- æ”¯æŒæµå¼å“åº”çš„å¤šçŠ¶æ€å±•ç¤º
- æ”¯æŒå·¥å…·è°ƒç”¨å±•ç¤º
- ä¿æŒä¸ç°æœ‰åç«¯ API å…¼å®¹

### Non-Goals
- ä¸ä¿®æ”¹åç«¯ API æ¥å£
- ä¸ä¿®æ”¹æ•°æ®åº“æ¨¡å‹
- ä¸å®ç° AgentX çš„å®Œæ•´åŠŸèƒ½ï¼ˆå¦‚ Agent ç®¡ç†ã€Image ç®¡ç†ï¼‰

## Decisions

### Decision 1: ç»„ä»¶é›†æˆæ–¹å¼

**é€‰æ‹©**: ä½¿ç”¨ @agentxjs/ui çš„åº•å±‚ç»„ä»¶ï¼Œè€Œéé¡¶å±‚ Studio ç»„ä»¶

**åŸå› **:
- Studio ç»„ä»¶åŒ…å« AgentListã€Image ç®¡ç†ç­‰åŠŸèƒ½ï¼Œä¸ç°æœ‰æ¶æ„ä¸å…¼å®¹
- åº•å±‚ç»„ä»¶ï¼ˆMessagePaneã€InputPaneã€UserEntryã€AssistantEntryï¼‰æ›´çµæ´»
- å¯ä»¥ä¿æŒç°æœ‰çš„é¢†åŸŸç®¡ç†ã€å¯¹è¯åˆ—è¡¨ç­‰é¡µé¢ä¸å˜

**ä½¿ç”¨çš„ç»„ä»¶**:
```typescript
// ä» @agentxjs/ui å¯¼å…¥
import {
  MessagePane,
  InputPane,
  UserEntry,
  AssistantEntry,
  ErrorEntry,
  MarkdownText,
  MessageContent,
} from "@agentxjs/ui";
```

### Decision 2: æ•°æ®æ¨¡å‹é€‚é…

**é€‰æ‹©**: åœ¨å‰ç«¯è¿›è¡Œæ•°æ®è½¬æ¢ï¼Œä¿æŒåç«¯ä¸å˜

**åŸå› **:
- åç«¯ API å·²ç¨³å®šï¼Œä¿®æ”¹æˆæœ¬é«˜
- å‰ç«¯è½¬æ¢æ›´çµæ´»ï¼Œå¯ä»¥é€æ­¥è¿ç§»
- ä¿æŒå‘åå…¼å®¹

**è½¬æ¢é€»è¾‘**:
```typescript
// å°† Message è½¬æ¢ä¸º ConversationData
function messageToConversation(message: Message): ConversationData {
  if (message.role === 'user') {
    return {
      type: 'user',
      id: message.id,
      content: message.content,
      timestamp: new Date(message.createdAt).getTime(),
      status: 'success',
    };
  }

  return {
    type: 'assistant',
    id: message.id,
    messageIds: [message.id],
    timestamp: new Date(message.createdAt).getTime(),
    status: message.isStreaming ? 'streaming' : 'completed',
    blocks: [{
      type: 'text',
      id: `text_${message.id}`,
      content: message.content,
      timestamp: new Date(message.createdAt).getTime(),
      status: message.isStreaming ? 'streaming' : 'completed',
    }],
  };
}
```

### Decision 3: WebSocket äº‹ä»¶æ ¼å¼

**é€‰æ‹©**: å…¼å®¹ä¸¤ç§äº‹ä»¶æ ¼å¼ï¼ˆåŸæœ‰æ ¼å¼ + AgentX æ ¼å¼ï¼‰

**åŸå› **:
- AgentX åç«¯å®é™…å‘é€çš„äº‹ä»¶æ ¼å¼ä¸åŸè®¾è®¡ä¸åŒ
- éœ€è¦åŒæ—¶æ”¯æŒ `content_delta` å’Œ `text_delta` äº‹ä»¶
- éœ€è¦åŒæ—¶æ”¯æŒ `message_start`/`message_complete` å’Œ `conversation_start`/`conversation_end`/`message_stop` äº‹ä»¶

**å®é™…äº‹ä»¶æ˜ å°„**:
| AgentX äº‹ä»¶ | åŸæœ‰äº‹ä»¶ | ç”¨é€” | UI çŠ¶æ€å˜åŒ– |
|------------|---------|------|------------|
| conversation_start | message_start | å¼€å§‹æ–°æ¶ˆæ¯ | åˆ›å»º streaming çŠ¶æ€çš„ AssistantEntry |
| text_delta | content_delta | è¿½åŠ æ–‡æœ¬å†…å®¹ | æ›´æ–° TextBlock å†…å®¹ |
| source_reference | source_reference | æ·»åŠ æ¥æºå¼•ç”¨ | æ›´æ–°æ¶ˆæ¯çš„ sources å­—æ®µ |
| conversation_end / message_stop | message_complete | æ¶ˆæ¯å®Œæˆ | å°†çŠ¶æ€æ”¹ä¸º completed |
| error | error | é”™è¯¯å‘ç”Ÿ | æ˜¾ç¤º ErrorEntry |

**å®ç°ä»£ç **:
```typescript
// useAgentXWebSocket.ts ä¸­çš„äº‹ä»¶å¤„ç†
case 'message_start':
case 'conversation_start': {
  // å…¼å®¹ä¸¤ç§äº‹ä»¶æ ¼å¼
  setMessageState('streaming');
  // ...
}

case 'content_delta':
case 'text_delta': {
  // å…¼å®¹ AgentX çš„ text_delta äº‹ä»¶
  const eventData = data.data as { delta?: string; text?: string };
  const delta = eventData?.delta || eventData?.text || '';
  // ...
}

case 'message_complete':
case 'conversation_end':
case 'message_stop': {
  // å…¼å®¹ AgentX äº‹ä»¶æ ¼å¼
  setMessageState('completed');
  // ...
}
```

### Decision 4: æ ·å¼é›†æˆ

**é€‰æ‹©**: ä½¿ç”¨ @agentxjs/ui çš„ Tailwind é…ç½®

**åŸå› **:
- @agentxjs/ui ä½¿ç”¨ Tailwind CSS
- å¯ä»¥å¤ç”¨ç°æœ‰çš„ Tailwind é…ç½®
- æ ·å¼å˜é‡ï¼ˆå¦‚ --background, --foregroundï¼‰ä¸ shadcn/ui å…¼å®¹

**é…ç½®**:
```typescript
// tailwind.config.ts
export default {
  content: [
    // æ·»åŠ  @agentxjs/ui çš„å†…å®¹è·¯å¾„
    "./node_modules/@agentxjs/ui/dist/**/*.{js,ts,jsx,tsx}",
  ],
  // ...
}
```

## Architecture

### ç»„ä»¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ChatPage                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ChatHeader                            â”‚   â”‚
â”‚  â”‚  (ä¿æŒç°æœ‰å®ç°)                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MessagePane                           â”‚   â”‚
â”‚  â”‚  (æ¥è‡ª @agentxjs/ui)                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚ UserEntry / AssistantEntry / ErrorEntry             â”‚â”‚   â”‚
â”‚  â”‚  â”‚ (æ¥è‡ª @agentxjs/ui)                                 â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ TextBlock / ToolBlock                           â”‚â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ (æ¥è‡ª @agentxjs/ui)                             â”‚â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ MarkdownText                                â”‚â”‚â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ (æ¥è‡ª @agentxjs/ui)                         â”‚â”‚â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    InputPane                             â”‚   â”‚
â”‚  â”‚  (æ¥è‡ª @agentxjs/ui æˆ–ä¿æŒç°æœ‰å®ç°)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
åç«¯ API (Message[])
       â”‚
       â–¼
useMessages hook
       â”‚
       â–¼
messageToConversation() è½¬æ¢
       â”‚
       â–¼
ConversationData[]
       â”‚
       â–¼
MessagePane + UserEntry/AssistantEntry
       â”‚
       â–¼
TextBlock + MarkdownText
```

### WebSocket æ•°æ®æµ

```
WebSocket äº‹ä»¶ (message_start/content_delta/message_complete/error)
       â”‚
       â–¼
useAgentXWebSocket hook
       â”‚
       â”œâ”€â”€â”€ message_start â”€â”€â†’ åˆ›å»ºæ–°çš„ streaming æ¶ˆæ¯
       â”‚
       â”œâ”€â”€â”€ content_delta â”€â”€â†’ è¿½åŠ æ–‡æœ¬åˆ°å½“å‰æ¶ˆæ¯
       â”‚
       â”œâ”€â”€â”€ message_complete â”€â”€â†’ æ ‡è®°æ¶ˆæ¯å®Œæˆ
       â”‚
       â””â”€â”€â”€ error â”€â”€â†’ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
       â”‚
       â–¼
messages çŠ¶æ€æ›´æ–°
       â”‚
       â–¼
MessagePane + UserEntry/AssistantEntry é‡æ–°æ¸²æŸ“
```

## Risks / Trade-offs

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| @agentxjs/ui ç‰ˆæœ¬æ›´æ–°å¯èƒ½ç ´åå…¼å®¹æ€§ | ä¸­ | é”å®šç‰ˆæœ¬ï¼Œå®šæœŸè¯„ä¼°å‡çº§ |
| æ•°æ®è½¬æ¢å¯èƒ½æœ‰æ€§èƒ½å¼€é”€ | ä½ | ä½¿ç”¨ useMemo ç¼“å­˜è½¬æ¢ç»“æœ |
| æ ·å¼å†²çª | ä¸­ | ä½¿ç”¨ CSS å˜é‡ï¼Œç¡®ä¿ä¸»é¢˜ä¸€è‡´ |
| åŒ…ä½“ç§¯å¢åŠ  | ä½ | Tree-shakingï¼Œåªå¯¼å…¥éœ€è¦çš„ç»„ä»¶ |

## Migration Plan

### Phase 1: åŸºç¡€é›†æˆï¼ˆ1-2 å¤©ï¼‰
1. å®‰è£…ä¾èµ–åŒ…
2. é…ç½® Tailwind CSS
3. åˆ›å»ºæ•°æ®è½¬æ¢å·¥å…·å‡½æ•°
4. æ›¿æ¢ MessageBubble ä¸º UserEntry/AssistantEntry

### Phase 2: åŠŸèƒ½å®Œå–„ï¼ˆ1-2 å¤©ï¼‰
1. é€‚é… WebSocket äº‹ä»¶
2. å®ç°æµå¼çŠ¶æ€å±•ç¤º
3. æ·»åŠ æ¶ˆæ¯ä¸­æ–­åŠŸèƒ½
4. æµ‹è¯•å’Œä¿®å¤é—®é¢˜

### Phase 3: å¢å¼ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
1. æ”¯æŒå·¥å…·è°ƒç”¨å±•ç¤º
2. æ”¯æŒå›¾ç‰‡æ¶ˆæ¯
3. ä¼˜åŒ–æ€§èƒ½

## Open Questions

1. ~~æ˜¯å¦éœ€è¦ä½¿ç”¨ @agentxjs/ui çš„ InputPaneï¼Ÿ~~
   - ç­”ï¼šå¦ï¼Œä¿æŒç°æœ‰ MessageInput ç»„ä»¶

2. ~~æ˜¯å¦éœ€è¦æ”¯æŒå·¥å…·è°ƒç”¨å±•ç¤ºï¼Ÿ~~
   - ç­”ï¼šPhase 5 å¯é€‰å®ç°ï¼Œå½“å‰åç«¯ä¸æ”¯æŒå·¥å…·è°ƒç”¨

3. ~~@agentxjs/ui æ˜¯å¦éœ€è¦å‘å¸ƒåˆ° npmï¼Ÿ~~
   - ç­”ï¼šå·²å‘å¸ƒï¼Œä½¿ç”¨ @agentxjs/ui@1.5.8 npm åŒ…

## Lessons Learned

1. **äº‹ä»¶æ ¼å¼å…¼å®¹æ€§**: AgentX åç«¯å®é™…å‘é€çš„äº‹ä»¶æ ¼å¼ä¸æ–‡æ¡£æè¿°ä¸åŒï¼Œéœ€è¦åœ¨å‰ç«¯åšå…¼å®¹å¤„ç†
2. **å¸ƒå±€é—®é¢˜**: ChatPage éœ€è¦ç‹¬ç«‹å¸ƒå±€ï¼Œä¸èƒ½åµŒå¥—åœ¨ Layout ç»„ä»¶ä¸­ï¼Œå¦åˆ™ flex å¸ƒå±€ä¼šå¯¼è‡´è¾“å…¥æ¡†æ¶ˆå¤±
3. **æ¶ˆæ¯å†…å®¹æ ¼å¼**: åç«¯è¿”å›çš„æ¶ˆæ¯å†…å®¹å¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²æ ¼å¼ï¼Œéœ€è¦è§£æåæå–å®é™…æ–‡æœ¬
